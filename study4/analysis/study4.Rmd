---
title: "Study 4"
subtitle: "Luhrmann, Weisman, et al."
output: 
  html_notebook:
    theme: flatly
    toc: true
    toc_float: true
---

In this notebook, we analyze Study 4: Confirmatory work with undergraduates.

```{r}
source("../../scripts_general/dependencies.R")
source("../../scripts_general/custom_funs.R")
source("../../scripts_general/var_recode_contrast.R")
```

```{r}
theme_set(theme_bw())
```

```{r}
d4_byquestion_raw <- read_csv("../data/study4_byquestion.csv") %>%
  select(-X1) %>%
  mutate(p7_ctry = factor(p7_ctry, levels = levels_country))

source("../scripts_s4/s4_var_groups.R")
```

```{r}
d4_byquestion <- full_join(d4_byquestion_raw %>%
                             select(p7_ctry, p7_subj, s4_var_pv) %>%
                             gather(question, response, s4_var_pv) %>%
                             mutate(scale = "pv_score"),
                           d4_byquestion_raw %>%
                             select(p7_ctry, p7_subj, s4_var_por) %>%
                             gather(question, response, s4_var_por) %>%
                             mutate(scale = "por_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_abs) %>%
              gather(question, response, s4_var_abs) %>%
              mutate(scale = "abs_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_dse) %>%
              gather(question, response, s4_var_dse) %>%
              mutate(scale = "dse_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_spev) %>%
              gather(question, response, s4_var_spev) %>%
              mutate(scale = "spev_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_hall) %>%
              gather(question, response, s4_var_hall) %>%
              mutate(scale = "hall_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_para) %>%
              gather(question, response, s4_var_para) %>%
              mutate(scale = "para_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_cog) %>%
              gather(question, response, s4_var_cog) %>%
              mutate(scale = "cog_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_ctl) %>%
              gather(question, response, s4_var_ctl) %>%
              mutate(scale = "ctl_score")) %>%
  mutate(p7_ctry = factor(p7_ctry, levels = levels_country))
```

```{r}
d4_0 <- d4_byquestion %>%
  group_by(p7_subj, scale) %>%
  mutate(score = mean(response, na.rm = T)) %>%
  ungroup() %>%
  mutate(study = "study 4") %>%
  distinct(study, p7_ctry, p7_subj, scale, score) %>%
  spread(scale, score)

d4_std <- d4_0 %>%
  group_by(study) %>%
  mutate_at(vars(ends_with("_score")), funs(std = scale)) %>%
  ungroup()

d4_std2 <- d4_0 %>%
  group_by(study, p7_ctry) %>%
  mutate_at(vars(ends_with("_score")), funs(std2 = scale)) %>%
  ungroup()

d4 <- d4_0 %>% full_join(d4_std) %>% full_join(d4_std2) %>%
  mutate(p7_ctry = factor(p7_ctry, levels = levels_country))
```

```{r}
contrasts(d4_byquestion$p7_ctry) <- contrasts_country
contrasts(d4$p7_ctry) <- contrasts_country
```


# Demographics

```{r}
# all participants included in dataset
d4 %>% distinct(p7_subj) %>% count()
```

```{r}
# participants missing porosity scale score
d4 %>% 
  filter(is.na(por_score)) %>% 
  distinct(as.character(p7_subj)) %>%
  count()

# participants missing porosity vignettes score
d4 %>% 
  filter(is.na(pv_score)) %>% 
  distinct(as.character(p7_subj)) %>%
  count()

# participants missing absorption score
d4 %>% 
  filter(is.na(abs_score)) %>% 
  distinct(as.character(p7_subj)) %>%
  count()

# participants missing daily spiritual experiences score
d4 %>% 
  filter(is.na(dse_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()

# participants missing spiritual events score
d4 %>% 
  filter(is.na(spev_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()

# participants missing hallucinations score
d4 %>% 
  filter(is.na(hall_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()

# participants missing paranormal score
d4 %>% 
  filter(is.na(para_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()

# participants missing sense of control score
d4 %>% 
  filter(is.na(ctl_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()

# participants missing need for cognition score
d4 %>% 
  filter(is.na(cog_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()


# participants with complete data for primary analysis
d4 %>% 
  filter(!is.na(por_score),
         !is.na(pv_score),
         !is.na(abs_score),
         !is.na(dse_score),
         !is.na(spev_score),
         !is.na(hall_score),
         !is.na(para_score),
         !is.na(ctl_score),
         !is.na(cog_score)) %>% 
  distinct(as.character(p7_subj)) %>% 
  count()
```

```{r}
s4_sub <- d4 %>% 
  filter(!is.na(por_score),
         !is.na(pv_score),
         !is.na(abs_score),
         !is.na(dse_score),
         !is.na(spev_score),
         !is.na(hall_score),
         !is.na(para_score),
         !is.na(ctl_score),
         !is.na(cog_score)) %>% 
  mutate(p7_subj = as.character(p7_subj)) %>%
  distinct(p7_subj)

d4x <- d4 %>% filter(p7_subj %in% s4_sub$p7_subj)
d4x_byquestion <- d4_byquestion %>% filter(p7_subj %in% s4_sub$p7_subj)
```

XX FILL IN MORE DEMOGRAPHICS


# Predicting Spiritual Experiences

```{r}
d4_long <- d4 %>%
  select(p7_ctry, p7_subj, 
         por_score_std, pv_score_std, abs_score_std, dse_score_std, spev_score_std) %>%
  gather(spirit_scale, spirit_score_std, 
         c(dse_score_std, spev_score_std)) %>%
  mutate(spirit_scale = factor(spirit_scale, 
                               levels = c("dse_score_std", "spev_score_std")))

contrasts(d4_long$p7_ctry) <- contrasts_country; contrasts(d4_long$p7_ctry)
contrasts(d4_long$spirit_scale) <- cbind("_spev" = c(-1, 1)); contrasts(d4_long$spirit_scale)
```

## Attempting to fit more complex random effects structures

```{r}
r1a <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
              (1 + por_score_std * abs_score_std | p7_ctry), d4_long) # singular
r1b <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
              (1 + por_score_std * abs_score_std || p7_ctry), d4_long) # singular
r1c <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
              (1 + por_score_std + abs_score_std || p7_ctry), d4_long) # singular
r1d <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
              (1 | p7_ctry), d4_long) # fine, but doesn't include scale or repeated measures
r1e <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
              (1 | p7_ctry/p7_subj), d4_long) # fine, but doesn't include scale
r1f <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
              (1 | p7_ctry/p7_subj) + (1 | spirit_scale), d4_long) # singular

r1f1 <- lmer(spirit_score_std ~ por_score_std * abs_score_std + 
               (1 | p7_ctry/p7_subj) + (1 | spirit_scale), d4_long) # singular
```

```{r}
temp <- lmer(spirit_score_std ~ por_score_std * abs_score_std +
               (1 | p7_ctry/p7_subj) + 
               # (0 + por_score_std * abs_score_std | spirit_scale), # singular
               # (0 + por_score_std * abs_score_std || spirit_scale), # singular
               (0 + por_score_std + abs_score_std || spirit_scale), #only 1df for abs
             # (0 + por_score_std | spirit_scale), #only <2df for por
             # (0 + abs_score_std | spirit_scale), # fails to converge
             d4_long)
summary(temp)
```

```{r}
r1g_por <- lmer(spirit_score_std ~ por_score_std * abs_score_std * spirit_scale +
                  (1 | p7_ctry/p7_subj), d4_long) # fine
regtab_fun(r1g_por, por_name = "Porosity Scale") %>% regtab_style_fun(row_emph = 2:3)
regtab_ran_fun(r1g_por, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
r1g_pv <- lmer(spirit_score_std ~ por_score_std * abs_score_std * spirit_scale +
                 (1 | p7_ctry/p7_subj), d4_long) # fine
regtab_fun(r1g_pv, por_name = "Porosity Vignettes") %>% regtab_style_fun(row_emph = 2:3)
regtab_ran_fun(r1g_pv, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
r1h_dse <- lmer(dse_score_std ~ por_score_std * abs_score_std + (1 | p7_ctry), d4)
regtab_fun(r1h_dse, por_name = "Porosity Scale") %>% regtab_style_fun(row_emph = 2:3)
```

```{r}
r1h_spev <- lmer(spev_score_std ~ por_score_std * abs_score_std + (1 | p7_ctry), d4)
regtab_fun(r1h_spev, por_name = "Porosity Scale") %>% regtab_style_fun(row_emph = 2:3)
```


```{r}
r1i_dse <- lmer(dse_score_std ~ pv_score_std * abs_score_std + (1 | p7_ctry), d4)
regtab_fun(r1i_dse, 
           por_var = "pv_score_std",
           por_name = "Porosity Vignettes") %>% 
  regtab_style_fun(row_emph = 2:3)
```

```{r}
r1i_spev <- lmer(spev_score_std ~ pv_score_std * abs_score_std + (1 | p7_ctry), d4)
regtab_fun(r1i_spev,
           por_var = "pv_score_std",
           por_name = "Porosity Vignettes") %>% 
  regtab_style_fun(row_emph = 2:3)
```

```{r}
# XX BOOKMARK: not good because doubles size of dataset!
# r1j_spev <- lmer(spev_score_std ~ POR * abs_score_std +
#                    (1 | p7_ctry) + (1 | por_scale),
#                  d4 %>%
#                    distinct(p7_ctry, p7_subj, spev_score_std, abs_score_std,
#                             por_score_std, pv_score_std) %>%
#                    gather(por_scale, POR, c(por_score_std, pv_score_std)) %>%
#                    mutate(por_scale = factor(por_scale)),
#                  contrasts = list(por_scale = "contr.sum"))
# regtab_fun(r1j_spev,
#            por_var = "POR",
#            por_name = "POROSITY (overall)") %>%
#   regtab_style_fun(row_emph = 2:3)
```



## Primary analyses

### Porosity Scale

```{r}
r1_por <- lmer(spirit_score_std ~ por_score_std * spirit_scale +
                 (1 | p7_ctry/p7_subj), d4_long) 
regtab_fun(r1_por, por_name = "Porosity Scale") %>% regtab_style_fun(row_emph = 2)
regtab_ran_fun(r1_por, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r1_por)
```

### Porosity Vignettes

```{r}
r1_pv <- lmer(spirit_score_std ~ pv_score_std * spirit_scale +
                (1 | p7_ctry/p7_subj), d4_long) 
regtab_fun(r1_pv, por_name = "Porosity Vignettes") %>% regtab_style_fun(row_emph = 2)
regtab_ran_fun(r1_pv, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r1_pv)
```

### Absorption

```{r}
r1_abs <- lmer(spirit_score_std ~ abs_score_std * spirit_scale +
                 (1 | p7_ctry/p7_subj), d4_long) 
regtab_fun(r1_abs) %>% regtab_style_fun(row_emph = 2)
regtab_ran_fun(r1_abs, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r1_abs)
```

## Bayesian regression

### Porosity Scale

```{r}
# r1_bayes_por <- brm(spirit_score_std ~ por_score_std * spirit_scale +
#                       (1 | p7_ctry/p7_subj), d4_long,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4) 
# saveRDS(r1_bayes_por, "./models/r1_bayes_por.RDS")

r1_bayes_por <- readRDS("./models/r1_bayes_por.RDS")
```

```{r}
regtab_fun(r1_bayes_por, por_name = "Porosity Scale") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r1_bayes_por, country_var = "p7_ctry", subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
bayes_R2(r1_bayes_por)
```

### Porosity Vignettes

```{r}
# r1_bayes_pv <- brm(spirit_score_std ~ pv_score_std * spirit_scale +
#                       (1 | p7_ctry/p7_subj), d4_long,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_bayes_pv, "./models/r1_bayes_pv.RDS")

r1_bayes_pv <- readRDS("./models/r1_bayes_pv.RDS")
```

```{r}
regtab_fun(r1_bayes_pv, por_var = "pv_score_std", por_name = "Porosity Vignettes") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r1_bayes_pv, country_var = "p7_ctry", subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
bayes_R2(r1_bayes_pv)
```

### Absorption

```{r}
# r1_bayes_abs <- brm(spirit_score_std ~ abs_score_std * spirit_scale +
#                       (1 | p7_ctry/p7_subj), d4_long,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_bayes_abs, "./models/r1_bayes_abs.RDS")

r1_bayes_abs <- readRDS("./models/r1_bayes_abs.RDS")
```

```{r}
regtab_fun(r1_bayes_abs) %>% regtab_style_fun(row_emph = 2)
regtab_ran_fun(r1_bayes_abs, country_var = "p7_ctry", subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
bayes_R2(r1_bayes_abs)
```


## Country as fixed effect

### Porosity Scale

```{r}
r2_por <- lmer(spirit_score_std ~ por_score_std * spirit_scale * p7_ctry +
                 (1 | p7_subj), d4_long) 
regtab_fun(r2_por, 
           por_name = "Porosity Scale",
           country_var1 = "p7_ctry_gh",
           country_var2 = "p7_ctry_th",
           country_var3 = "p7_ctry_ch",
           country_var4 = "p7_ctry_vt") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r2_por, subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r2_por)
```

### Porosity Vignettes

```{r}
r2_pv <- lmer(spirit_score_std ~ pv_score_std * spirit_scale * p7_ctry +
                (1 | p7_subj), d4_long) 
regtab_fun(r2_pv, 
           por_var = "pv_score_std",
           por_name = "Porosity Vignettes",
           country_var1 = "p7_ctry_gh",
           country_var2 = "p7_ctry_th",
           country_var3 = "p7_ctry_ch",
           country_var4 = "p7_ctry_vt",
           scale_var = "spirit_scale_spev") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r2_pv, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r2_pv)
```

### Absorption

```{r}
r2_abs <- lmer(spirit_score_std ~ abs_score_std * spirit_scale * p7_ctry +
                 (1 | p7_subj), d4_long) 
regtab_fun(r2_abs, 
           country_var1 = "p7_ctry_gh", 
           country_var2 = "p7_ctry_th",
           country_var3 = "p7_ctry_ch",
           country_var4 = "p7_ctry_vt",
           scale_var = "spirit_scale_spev",
           scale_name = "Scale (Sp. Ev.)") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r2_abs, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r2_abs)
```




## Within each site considered alone

```{r}
d4_long_bycountry <- d4 %>%
  select(p7_ctry, p7_subj, 
         por_score_std2, pv_score_std2, abs_score_std2, 
         dse_score_std2, spev_score_std2) %>%
  gather(spirit_scale, spirit_score_std2, 
         c(dse_score_std2, spev_score_std2)) %>%
  mutate(spirit_scale = factor(spirit_scale, 
                               levels = c("dse_score_std2", "spev_score_std2")))

contrasts(d4_long_bycountry$p7_ctry) <- contrasts_country; contrasts(d4_long$p7_ctry)
contrasts(d4_long_bycountry$spirit_scale) <- cbind("_spev" = c(-1, 1)); contrasts(d4_long_bycountry$spirit_scale)
```

### Porosity Scale

```{r}
r1_por_us <- lmer(spirit_score_std2 ~ por_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "US")) 
r1_por_gh <- lmer(spirit_score_std2 ~ por_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Ghana")) 
r1_por_th <- lmer(spirit_score_std2 ~ por_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Thailand")) 
r1_por_ch <- lmer(spirit_score_std2 ~ por_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "China")) 
r1_por_vt <- lmer(spirit_score_std2 ~ por_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Vanuatu")) 
```

```{r}
r1_por_bycountry <- bind_rows(
  r1_por_us %>% 
    regtab_fun(por_var = "por_score_std2", por_name = "Porosity Scale") %>% 
    mutate(Country = "US"),
  r1_por_gh %>% 
    regtab_fun(por_var = "por_score_std2", por_name = "Porosity Scale") %>% 
    mutate(Country = "Ghana"),
  r1_por_th %>% 
    regtab_fun(por_var = "por_score_std2", por_name = "Porosity Scale") %>% 
    mutate(Country = "Thailand"),
  r1_por_ch %>% 
    regtab_fun(por_var = "por_score_std2", por_name = "Porosity Scale") %>% 
    mutate(Country = "China"),
  r1_por_vt %>% 
    regtab_fun(por_var = "por_score_std2", por_name = "Porosity Scale") %>% 
    mutate(Country = "Vanuatu"))
```

```{r}
r1_por_bycountry %>%
  filter(Parameter == "Porosity Scale")
```

### Porosity Vignettes

```{r}
r1_pv_us <- lmer(spirit_score_std2 ~ pv_score_std2 * spirit_scale +
                   (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "US")) 
r1_pv_gh <- lmer(spirit_score_std2 ~ pv_score_std2 * spirit_scale +
                   (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Ghana")) 
r1_pv_th <- lmer(spirit_score_std2 ~ pv_score_std2 * spirit_scale +
                   (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Thailand")) 
r1_pv_ch <- lmer(spirit_score_std2 ~ pv_score_std2 * spirit_scale +
                   (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "China")) 
r1_pv_vt <- lmer(spirit_score_std2 ~ pv_score_std2 * spirit_scale +
                   (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Vanuatu")) 
```

```{r}
r1_pv_bycountry <- bind_rows(
  r1_pv_us %>% 
    regtab_fun(por_var = "pv_score_std2", por_name = "Porosity Vignettes") %>% 
    mutate(Country = "US"),
  r1_pv_gh %>% 
    regtab_fun(por_var = "pv_score_std2", por_name = "Porosity Vignettes") %>% 
    mutate(Country = "Ghana"),
  r1_pv_th %>% 
    regtab_fun(por_var = "pv_score_std2", por_name = "Porosity Vignettes") %>% 
    mutate(Country = "Thailand"),
  r1_pv_ch %>% 
    regtab_fun(por_var = "pv_score_std2", por_name = "Porosity Vignettes") %>% 
    mutate(Country = "China"),
  r1_pv_vt %>% 
    regtab_fun(por_var = "pv_score_std2", por_name = "Porosity Vignettes") %>% 
    mutate(Country = "Vanuatu"))
```

```{r}
r1_pv_bycountry %>%
  filter(Parameter == "Porosity Vignettes")
```

### Absorption

```{r}
r1_abs_us <- lmer(spirit_score_std2 ~ abs_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "US")) 
r1_abs_gh <- lmer(spirit_score_std2 ~ abs_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Ghana")) 
r1_abs_th <- lmer(spirit_score_std2 ~ abs_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Thailand")) 
r1_abs_ch <- lmer(spirit_score_std2 ~ abs_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "China")) 
r1_abs_vt <- lmer(spirit_score_std2 ~ abs_score_std2 * spirit_scale +
                    (1 | p7_subj), d4_long_bycountry %>% filter(p7_ctry == "Vanuatu")) 
```

```{r}
r1_abs_bycountry <- bind_rows(
  r1_abs_us %>% 
    regtab_fun(abs_var = "abs_score_std2") %>% 
    mutate(Country = "US"),
  r1_abs_gh %>% 
    regtab_fun(abs_var = "abs_score_std2") %>% 
    mutate(Country = "Ghana"),
  r1_abs_th %>% 
    regtab_fun(abs_var = "abs_score_std2") %>% 
    mutate(Country = "Thailand"),
  r1_abs_ch %>% 
    regtab_fun(abs_var = "abs_score_std2") %>% 
    mutate(Country = "China"),
  r1_abs_vt %>% 
    regtab_fun(abs_var = "abs_score_std2") %>% 
    mutate(Country = "Vanuatu"))
```

```{r}
r1_abs_bycountry %>%
  filter(Parameter == "Absorption")
```

## Comparison

```{r}
bind_rows(r1_por_bycountry %>% filter(Parameter == "Porosity Scale"),
          r1_pv_bycountry %>% filter(Parameter == "Porosity Vignettes"),
          r1_abs_bycountry %>% filter(Parameter == "Absorption")) %>%
  filter(` ` != "") %>%
  # filter(Country != "Vanuatu") %>%
  summarise(min_beta = min(β),
            max_p = max(p))
```

```{r}
bind_rows(r1_por_bycountry %>% filter(Parameter == "Porosity Scale"),
          r1_pv_bycountry %>% filter(Parameter == "Porosity Vignettes"),
          r1_abs_bycountry %>% filter(Parameter == "Absorption")) %>%
  filter(` ` == "")
```

```{r}
d4_long_bycountry %>% distinct(p7_ctry, p7_subj) %>% count(p7_ctry)
```


# Predicting other extraordinary experiences

## Primary analyses

```{r}
d4_long_other <- d4 %>%
  select(p7_ctry, p7_subj, 
         por_score_std, pv_score_std, abs_score_std, hall_score_std, para_score_std) %>%
  gather(other_scale, other_score_std, 
         c(hall_score_std, para_score_std)) %>%
  mutate(other_scale = factor(other_scale, 
                              levels = c("hall_score_std", "para_score_std")))

contrasts(d4_long_other$p7_ctry) <- contrasts_country; contrasts(d4_long$p7_ctry)
contrasts(d4_long_other$other_scale) <- cbind("_para" = c(-1, 1)); contrasts(d4_long_other$other_scale)
```

### Porosity Scale

```{r}
r2_por <- lmer(other_score_std ~ por_score_std * other_scale +
                 (1 | p7_ctry/p7_subj), d4_long_other) 
regtab_fun(r2_por, 
           por_name = "Porosity Scale", scale_var = "other_scale_para",
           scale_name = "Other Experience scale (Paranormal)") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r2_por, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

```{r}
rsquared(r2_por)
```

### Porosity Vignettes

```{r}
r2_pv <- lmer(other_score_std ~ pv_score_std * other_scale +
                (1 | p7_ctry/p7_subj), d4_long_other) 
regtab_fun(r2_pv, por_var = "pv_score_std", por_name = "Porosity Vignettes",
           scale_var = "other_scale_para",
           scale_name = "Other Experience scale (Paranormal") %>% 
  regtab_style_fun(row_emph = 2)
regtab_ran_fun(r2_pv, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```

### Absorption

```{r}
r2_abs <- lmer(other_score_std ~ abs_score_std * other_scale +
                 (1 | p7_ctry/p7_subj), d4_long_other) 
regtab_fun(r2_abs, scale_var = "other_scale_para", scale_name = "Other Experience scale (Para.)") %>% regtab_style_fun(row_emph = 2)
regtab_ran_fun(r2_abs, country_var = "p7_ctry", subj_var = "p7_subj") %>% regtab_style_fun()
```


# Comparing to control measures

## All control questions

```{r}
d4_control <- d4 %>% select(p7_ctry, p7_subj, ends_with("_std")) %>%
  gather(predictor, score, c(por_score_std, pv_score_std, abs_score_std, 
                             ctl_score_std, cog_score_std)) %>%
  mutate(predictor = factor(predictor, 
                            levels = c("por_score_std", "pv_score_std", "abs_score_std", 
                                       "ctl_score_std", "cog_score_std")))

contrasts(d4_control$predictor) <- cbind("_intVctl" = c(2, 2, 2, -3, -3),
                                         "_porVabs" = c(1, 1, -2, 0, 0),
                                         "_porVpv" = c(1, -1, 0, 0, 0),
                                         "_cogVctl" = c(0, 0, 0, -1, 1))
contrasts(d4_control$predictor)

contrasts(d4_control$p7_ctry)
```

### Daily Spiritual Experiences

```{r}
r3_dse <- lm(dse_score_std ~ score * predictor * p7_ctry, d4_control)
regtab_fun(r3_dse, 
           country_var1 = "p7_ctry_gh", 
           country_var2 = "p7_ctry_th", 
           country_var3 = "p7_ctry_ch", 
           country_var4 = "p7_ctry_vt",
           scale_var = "score",
           scale_name = "Predictor score") %>% 
  regtab_style_fun(row_emph = 11) ## XX BOOKMARK
```

```{r}
rsquared(r3_dse)
```

### Spiritual Events

```{r}
r3_spev <- lm(spev_score_std ~ score * predictor * p7_ctry, d4_control)
regtab_fun(r3_spev, 
           country_var1 = "p7_ctry_gh", 
           country_var2 = "p7_ctry_th", 
           country_var3 = "p7_ctry_ch", 
           country_var4 = "p7_ctry_vt",
           scale_var = "score",
           scale_name = "Predictor score") %>% 
  regtab_style_fun(row_emph = 11) ## XX BOOKMARK
```

```{r}
rsquared(r3_spev)
```

## Omitting reverse-coded items from control scales

```{r}
d4_scored_norev <- d4_byquestion %>% 
  filter(scale %in% c("cog_score", "ctl_score")) %>%
  # omit reverse-coded items from need for cognition (9 of 18 items)
  filter(!question %in% c("p7_hthk_not.fun", "p7_hthk_lil.challeng", 
                          "p7_hthk_avoid.think", "p7_hthk_hrd.hav.to", 
                          "p7_hthk_smal.daily", "p7_hthk_lil.thought", 
                          "p7_hthk_not.exciting", "p7_hthk_mental.effrt", 
                          "p7_hthk_job.done")) %>%
  # omit reverse-coded items from sense of control (4 of 12 items)
  filter(!question %in% c("p7_wob_set.mind_reverse", "p7_wob_find.ways_reverse",
                          "p7_wob_own.hands_reverse", "p7_wob_future.on.me_reverse")) %>%
  group_by(p7_ctry, p7_subj, scale) %>%
  summarise(score = mean(response, na.rm = T)) %>%
  ungroup() %>%
  spread(scale, score) %>%
  mutate(study = "study 4") %>%
  group_by(study) %>%
  mutate_at(vars(cog_score, ctl_score), funs(std = scale(.))) %>%
  ungroup() %>%
  group_by(study, p7_ctry) %>%
  mutate_at(vars(cog_score, ctl_score), funs(std2 = scale(.))) %>%
  ungroup()
```


```{r}
d4_control_norev <- d4 %>% select(p7_ctry, p7_subj, ends_with("_std")) %>%
  # replace with scores that omit reverse-coded items
  select(-cog_score_std, -ctl_score_std) %>%
  full_join(d4_scored_norev %>% select(p7_subj, ends_with("_std"))) %>%
  gather(predictor, score, c(por_score_std, pv_score_std, abs_score_std, 
                             ctl_score_std, cog_score_std)) %>%
  mutate(predictor = factor(predictor, 
                            levels = c("por_score_std", "pv_score_std", "abs_score_std", 
                                       "ctl_score_std", "cog_score_std")))

contrasts(d4_control_norev$predictor) <- cbind("_intVctl" = c(2, 2, 2, -3, -3),
                                               "_porVabs" = c(1, 1, -2, 0, 0),
                                               "_porVpv" = c(1, -1, 0, 0, 0),
                                               "_cogVctl" = c(0, 0, 0, -1, 1))
contrasts(d4_control_norev$predictor)

contrasts(d4_control_norev$p7_ctry)
```

### Daily Spiritual Experiences

```{r}
r4_dse <- lm(dse_score_std ~ score * predictor * p7_ctry, d4_control_norev)
regtab_fun(r4_dse, 
           country_var1 = "p7_ctry_gh", 
           country_var2 = "p7_ctry_th", 
           country_var3 = "p7_ctry_ch", 
           country_var4 = "p7_ctry_vt",
           scale_var = "score",
           scale_name = "Predictor score") %>% 
  regtab_style_fun(row_emph = 11) ## XX BOOKMARK
```

```{r}
rsquared(r4_dse)
```

### Spiritual Events

```{r}
r4_spev <- lm(spev_score_std ~ score * predictor * p7_ctry, d4_control_norev)
regtab_fun(r4_spev, 
           country_var1 = "p7_ctry_gh", 
           country_var2 = "p7_ctry_th", 
           country_var3 = "p7_ctry_ch", 
           country_var4 = "p7_ctry_vt",
           scale_var = "score",
           scale_name = "Predictor score") %>% 
  regtab_style_fun(row_emph = 11) ## XX BOOKMARK
```

```{r}
rsquared(r4_spev)
```


# Porosity and absorption differentially predicting individual extraordinary experiences

```{r}
d4_different <- d4 %>%
  select(p7_ctry, p7_subj, por_score_std, pv_score_std, abs_score_std) %>%
  full_join(d4_byquestion %>% 
              select(-scale) %>%
              # standardize responses by question (collapsing across countries)
              group_by(question) %>%
              mutate(response = scale(response)) %>%
              ungroup() %>%
              spread(question, response) %>%
              select(p7_subj, s4_var_dse, s4_var_spev, s4_var_hall, s4_var_para))
```

```{r}
d4_different_cor <- d4_different %>%
  select(-p7_ctry, -p7_subj) %>%
  # unite(p7_ctry.p7_subj, p7_ctry, p7_subj, sep = "_") %>%
  # column_to_rownames("p7_ctry.p7_subj") %>%
  cor(use = "pairwise.complete") %>%
  data.frame() %>%
  rownames_to_column("var1") %>%
  gather(var2, cor, -var1)
```

```{r}
d4_different_cor2 <- d4_different_cor %>%
  filter(grepl("score", var1),
         !grepl("score", var2)) %>%
  mutate(var1 = factor(
    var1, 
    levels = c("por_score_std", "pv_score_std", "abs_score_std"),
    labels = c("Porosity Scale", "Porosity Vignettes", "Absorption"))) %>%
  left_join(d4_byquestion %>% 
              distinct(scale, question), 
            by = c("var2" = "question")) %>%
  distinct() %>%
  mutate(scale = factor(
    scale,
    levels = c("dse_score", "spev_score", "hall_score", "para_score"),
    labels = c("Daily Spiritual Experiences\n(Underwood & Teresi, 2002)", 
               "Spiritual Events\n(novel measure)",
               "Hallucinations\n(Morrison et al., 2000)", 
               "Paranormal\n(Thalborne & Delin, 1993)")),
    var2_lab = factor(var2,
                      levels = c(s4_var_dse, s4_var_spev, s4_var_hall, s4_var_para),
                      labels = c(paste("Item", 1:length(s4_var_dse)),
                                 paste("Item", 1:length(s4_var_spev)),
                                 paste("Item", 1:length(s4_var_hall)),
                                 paste("Item", 1:length(s4_var_para))))) %>%
  rename(predictor = var1, experience = var2, experience_lab = var2_lab)
```

```{r}
d4_different_cor_top4 <- d4_different_cor2 %>%
  group_by(predictor) %>%
  top_n(4, cor) %>%
  arrange(predictor, desc(cor))
d4_different_cor_top4 %>% kable(digits = 2) %>% kable_styling() %>% collapse_rows(1)

d4_different_cor_top4_spev <- d4_different_cor2 %>%
  filter(grepl("Spiritual Events", scale)) %>%
  group_by(predictor) %>%
  top_n(4, cor) %>%
  arrange(predictor, desc(cor))
# d4_different_cor_top4_spev %>% kable(digits = 2) %>% kable_styling() %>% collapse_rows(1)

d4_different_cor_top4_dse <- d4_different_cor2 %>%
  filter(grepl("Daily Spiritual Experiences", scale)) %>%
  group_by(predictor) %>%
  top_n(4, cor) %>%
  arrange(predictor, desc(cor))
# d4_different_cor_top4_dse %>% kable(digits = 2) %>% kable_styling() %>% collapse_rows(1)

d4_different_cor_top4_hall <- d4_different_cor2 %>%
  filter(grepl("Hallucinations", scale)) %>%
  group_by(predictor) %>%
  top_n(4, cor) %>%
  arrange(predictor, desc(cor))
# d4_different_cor_top4_hall %>% kable(digits = 2) %>% kable_styling() %>% collapse_rows(1)

d4_different_cor_top4_para <- d4_different_cor2 %>%
  filter(grepl("Paranormal", scale)) %>%
  group_by(predictor) %>%
  top_n(4, cor) %>%
  arrange(predictor, desc(cor))
# d4_different_cor_top4_para %>% kable(digits = 2) %>% kable_styling() %>% collapse_rows(1)
```

```{r, fig.width = 2.5, fig.asp = 2.5}
d4_different_cor2 %>%
  left_join(d4_different_cor_top4 %>% mutate(top4 = "bold")) %>%
  mutate(top4 = case_when(is.na(top4) ~ "plain", TRUE ~ top4)) %>%
  ggplot(aes(x = predictor, y = reorder(experience_lab, desc(experience_lab)), 
             fill = cor, label = format(round(cor, 2), nsmall = 2))) +
  facet_grid(scale ~ ., scales = "free", space = "free") +
  geom_tile(aes(size = top4), 
            color = "black", show.legend = T) +
  geom_text(aes(fontface = top4), 
            size = 3) +
  scale_fill_distiller(palette = "RdYlBu", limits = c(-1, 1),
                       guide = guide_colorbar(barwidth = 10, barheight = 0.5)) +
  scale_size_manual(values = c(0.5, 0.05)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Predictor", y = "Experience Item", fill = "Pearson's r") +
  guides(size = "none")
```

```{r}
d4_different_cor2 %>% 
  select(scale, experience_lab, predictor, cor) %>%
  spread(predictor, cor) %>%
  rename(Scale = scale, Item = experience_lab) %>%
  kable(digits = 2) %>%
  kable_styling() # %>%
  # collapse_rows(1)
```


# Porosity and absorption in a single model

## Parallels to primary analysis

### Porosity indexed by Porosity Scale

```{r}
r5_por_abs <- lmer(spirit_score_std ~ por_score_std * abs_score_std * spirit_scale +
                     (1 | p7_ctry/p7_subj), d4_long)
regtab_fun(r5_por_abs, por_name = "Porosity Scale") %>% 
  regtab_style_fun(row_emph = 2:3)
regtab_ran_fun(r5_por_abs, country_var = "p7_ctry", subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
rsquared(r5_por_abs)
```

### Porosity indexed by Porosity Vignettes

```{r}
r5_pv_abs <- lmer(spirit_score_std ~ pv_score_std * abs_score_std * spirit_scale +
                     (1 | p7_ctry/p7_subj), d4_long)
regtab_fun(r5_pv_abs, por_var = "pv_score_std", por_name = "Porosity Vignettes") %>% 
  regtab_style_fun(row_emph = 2:3)
regtab_ran_fun(r5_pv_abs, country_var = "p7_ctry", subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
rsquared(r5_pv_abs)
```

## Country as fixed effect

### Porosity indexed by Porosity Scale

```{r}
r6_por_abs <- lmer(spirit_score_std ~ por_score_std * abs_score_std * spirit_scale * 
                     p7_ctry + (1 | p7_subj), d4_long)
regtab_fun(r6_por_abs, 
           por_name = "Porosity Scale",
           country_var1 = "p7_ctry_gh",
           country_var2 = "p7_ctry_th",
           country_var3 = "p7_ctry_ch",
           country_var4 = "p7_ctry_vt") %>% 
  regtab_style_fun(row_emph = 2:3)
regtab_ran_fun(r6_por_abs, subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
rsquared(r6_por_abs)
```

### Porosity indexed by Porosity Vignettes

```{r}
r6_pv_abs <- lmer(spirit_score_std ~ pv_score_std * abs_score_std * spirit_scale * 
                    p7_ctry + (1 | p7_subj), d4_long)
regtab_fun(r6_pv_abs, 
           por_var = "pv_score_std", 
           por_name = "Porosity Vignettes",
           country_var1 = "p7_ctry_gh",
           country_var2 = "p7_ctry_th",
           country_var3 = "p7_ctry_ch",
           country_var4 = "p7_ctry_vt") %>% 
  regtab_style_fun(row_emph = 2:3)
regtab_ran_fun(r6_pv_abs, subj_var = "p7_subj") %>% 
  regtab_style_fun()
```

```{r}
rsquared(r6_pv_abs)
```



# Cultural invitation vs. individual difference

XX BOOKMARK
