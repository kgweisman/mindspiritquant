---
title: "Study 4: Extra analyses (not reported)"
subtitle: "Luhrmann, Weisman, et al."
output: 
  html_notebook:
    theme: flatly
    toc: true
    toc_float: true
---

In this notebook, we conducted extra analyses (not reported) for Study 4: Confirmatory work with undergraduates.

```{r}
source("../../scripts_general/dependencies.R")
source("../../scripts_general/custom_funs.R")
source("../../scripts_general/var_recode_contrast.R")
```

```{r}
theme_set(theme_bw())
```

```{r}
d4_byquestion_raw <- read_csv("../data/study4_byquestion.csv") %>%
  select(-X1) %>%
  mutate(p7_ctry = factor(p7_ctry, levels = levels_country))

source("../scripts_s4/s4_var_groups.R")
```

```{r}
d4_byquestion <- full_join(d4_byquestion_raw %>%
                             select(p7_ctry, p7_subj, s4_var_pv) %>%
                             gather(question, response, s4_var_pv) %>%
                             mutate(scale = "pv_score"),
                           d4_byquestion_raw %>%
                             select(p7_ctry, p7_subj, s4_var_por) %>%
                             gather(question, response, s4_var_por) %>%
                             mutate(scale = "por_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_abs) %>%
              gather(question, response, s4_var_abs) %>%
              mutate(scale = "abs_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_dse) %>%
              gather(question, response, s4_var_dse) %>%
              mutate(scale = "dse_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_spev) %>%
              gather(question, response, s4_var_spev) %>%
              mutate(scale = "spev_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_hall) %>%
              gather(question, response, s4_var_hall) %>%
              mutate(scale = "hall_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_para) %>%
              gather(question, response, s4_var_para) %>%
              mutate(scale = "para_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_cog) %>%
              gather(question, response, s4_var_cog) %>%
              mutate(scale = "cog_score")) %>%
  full_join(d4_byquestion_raw %>%
              select(p7_ctry, p7_subj, s4_var_ctl) %>%
              gather(question, response, s4_var_ctl) %>%
              mutate(scale = "ctl_score")) %>%
  mutate(p7_ctry = factor(p7_ctry, levels = levels_country))
```

```{r}
d4_0 <- d4_byquestion %>%
  group_by(p7_subj, scale) %>%
  mutate(score = mean(response, na.rm = T)) %>%
  ungroup() %>%
  mutate(study = "study 4") %>%
  distinct(study, p7_ctry, p7_subj, scale, score) %>%
  spread(scale, score)

d4_std <- d4_0 %>%
  group_by(study) %>%
  mutate_at(vars(ends_with("_score")), funs(std = scale)) %>%
  ungroup()

d4_std2 <- d4_0 %>%
  group_by(study, p7_ctry) %>%
  mutate_at(vars(ends_with("_score")), funs(std2 = scale)) %>%
  ungroup()

d4 <- d4_0 %>% full_join(d4_std) %>% full_join(d4_std2) %>%
  mutate(p7_ctry = factor(p7_ctry, levels = levels_country))
```

```{r}
contrasts(d4_byquestion$p7_ctry) <- contrasts_country
contrasts(d4$p7_ctry) <- contrasts_country
```

## Attempting to fit more complex random effects structures

```{r}
# more complex random effects structures: NOT REPORTED
# note: never looking for intercepts (random or fixed) by scale, because standardized
r1a <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | p7_ctry/p7_subj) +
              (0 + abs_score_std | p7_ctry) +
              (0 + abs_score_std | spirit_scale),
            data = d4_long) # singular

r1b <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | p7_ctry/p7_subj) +
              (0 + abs_score_std | p7_ctry),
            data = d4_long) # singular

r1c <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | p7_ctry/p7_subj) +
              (0 + abs_score_std | spirit_scale),
            data = d4_long) # failed to converge

r1d <- lmer(spirit_score_std ~ abs_score_std + 
              (0 + abs_score_std | p7_ctry) +
              (0 + abs_score_std | spirit_scale),
            data = d4_long) # fine, but doesn't reflect repeated measures design

r1e <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 + abs_score_std | p7_ctry), # singular
            # (1 + abs_score_std || p7_ctry), # failed to converge
            data = d4_long) # singular

r1f <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | p7_ctry/p7_subj),
            data = d4_long) # fine, but doesn't account for two scales

r1g <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (0 + abs_score_std | spirit_scale),
            data = d4_long) # overparameterized: only 1 df for testing main effect of abs_score

r1h <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 + abs_score_std | p7_ctry) + (1 | p7_subj),
            data = d4_long) # singular
```

```{r}
r1i_dse <- lmer(dse_score_std ~ abs_score_std +
                  (1 + abs_score_std | p7_ctry), d4) # singular

r1i_spev <- lmer(spev_score_std ~ abs_score_std +
                   (1 + abs_score_std | p7_ctry), d4) # singular
```



## Primary analysis

### Daily Spiritual Experiences

```{r}
r1_dse <- lmer(dse_score_std ~ abs_score_std + 
                 (1 + abs_score_std || p7_ctry), d4)
summary(r1_dse)
```

```{r}
rsquared(r1_dse)
```

```{r}
regtab_fun(r1_dse) %>%
  kable(align = c(rep("r", ncol(.) - 1), "l")) %>%
  kable_styling(font_size = 16) %>%
  row_spec(2, bold = T) %>%
  row_spec(1:nrow(regtab_fun(r1_dse)), color = "black")
```

```{r}
# regtab_ran_fun(r1_dse) %>%
#   mutate(Group = case_when(is.na(Group) ~ "Participant, nested within p7_ctry",
#                            TRUE ~ as.character(Group)),
#          Group = factor(Group, levels = c("p7_ctry", 
#                                           "Participant, nested within p7_ctry", 
#                                           "Residual"))) %>%
#   arrange(Group) %>%
#   kable(align = "r") %>%
#   kable_styling(font_size = 16) %>%
#   row_spec(1:nrow(regtab_ran_fun(r1_dse)), color = "black")
```

### Spiritual Events

```{r}
r1_spev <- lmer(spev_score_std ~ abs_score_std + 
                  (1 + abs_score_std || p7_ctry), d4)
summary(r1_spev)
```

```{r}
rsquared(r1_spev)
```

```{r}
regtab_fun(r1_spev) %>%
  kable(align = c(rep("r", ncol(.) - 1), "l")) %>%
  kable_styling(font_size = 16) %>%
  row_spec(2, bold = T) %>%
  row_spec(1:nrow(regtab_fun(r1_spev)), color = "black")
```

```{r}
# regtab_ran_fun(r1_spev) %>%
#   mutate(Group = case_when(is.na(Group) ~ "Participant, nested within p7_ctry",
#                            TRUE ~ as.character(Group)),
#          Group = factor(Group, levels = c("p7_ctry", 
#                                           "Participant, nested within p7_ctry", 
#                                           "Residual"))) %>%
#   arrange(Group) %>%
#   kable(align = "r") %>%
#   kable_styling(font_size = 16) %>%
#   row_spec(1:nrow(regtab_ran_fun(r1_spev)), color = "black")
```

## Bayesian regression

### Daily Spiritual Experiences

```{r}
# r1_dse_bayes <- brm(dse_score_std ~ abs_score_std +
#                       (1 + abs_score_std || p7_ctry), d4,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_dse_bayes, "./models/r1_dse_bayes.RDS")

r1_dse_bayes <- readRDS("./models/r1_dse_bayes.RDS")

summary(r1_dse_bayes)
```

```{r}
bayes_R2(r1_dse_bayes)
```

```{r}
regtab_fun(r1_dse_bayes) %>%
  kable(align = c(rep("r", ncol(.) - 1), "l")) %>%
  kable_styling(font_size = 16) %>%
  row_spec(2, bold = T) %>%
  row_spec(1:nrow(regtab_fun(r1_dse_bayes)), color = "black")
```

```{r}
# XX NEED TO OVERWRITE "p7_ctry" FOR INDIVIDUAL SUBJECTS
regtab_ran_fun(r1_dse_bayes) %>%
  kable(align = "r") %>%
  kable_styling(font_size = 16) %>%
  row_spec(1:nrow(regtab_ran_fun(r1_dse_bayes)), color = "black")
```

### Spiritual Events

```{r}
# r1_spev_bayes <- brm(spev_score_std ~ abs_score_std +
#                       (1 + abs_score_std || p7_ctry), d4,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_spev_bayes, "./models/r1_spev_bayes.RDS")

r1_spev_bayes <- readRDS("./models/r1_spev_bayes.RDS")

summary(r1_spev_bayes)
```

```{r}
bayes_R2(r1_spev_bayes)
```

```{r}
regtab_fun(r1_spev_bayes) %>%
  kable(align = c(rep("r", ncol(.) - 1), "l")) %>%
  kable_styling(font_size = 16) %>%
  row_spec(2, bold = T) %>%
  row_spec(1:nrow(regtab_fun(r1_spev_bayes)), color = "black")
```

```{r}
# XX NEED TO OVERWRITE "p7_ctry" FOR INDIVIDUAL SUBJECTS
regtab_ran_fun(r1_spev_bayes) %>%
  kable(align = "r") %>%
  kable_styling(font_size = 16) %>%
  row_spec(1:nrow(regtab_ran_fun(r1_spev_bayes)), color = "black")
```

## p7_ctry as fixed effect

### Daily Spiritual Experiences

```{r}
r2_dse <- lm(dse_score_std ~ abs_score_std * p7_ctry, d4)
summary(r2_dse)
```

```{r}
rsquared(r2_dse)
```

```{r}
regtab_fun(r2_dse) %>%
  kable(align = c(rep("r", ncol(.) - 1), "l")) %>%
  kable_styling(font_size = 16) %>%
  row_spec(2, bold = T) %>%
  row_spec(1:nrow(regtab_fun(r2_dse)), color = "black")
```


### Spiritual Events

```{r}
r2_spev <- lm(spev_score_std ~ abs_score_std * p7_ctry, d4)
summary(r2_spev)
```

```{r}
rsquared(r2_spev)
```

```{r}
regtab_fun(r2_spev) %>%
  kable(align = c(rep("r", ncol(.) - 1), "l")) %>%
  kable_styling(font_size = 16) %>%
  row_spec(2, bold = T) %>%
  row_spec(1:nrow(regtab_fun(r2_spev)), color = "black")
```


