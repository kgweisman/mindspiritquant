---
title: "Study 3"
subtitle: "Luhrmann, Weisman, et al."
output: 
  html_notebook:
    theme: flatly
    toc: true
    toc_float: true
---

In this notebook, we analyze Study 3: Short-form interviews with the general population.

```{r}
source("../../scripts_general/dependencies.R")
source("../../scripts_general/custom_funs.R")
source("../../scripts_general/var_recode_contrast.R")
source("../scripts_s3/s3_var_groups.R")
source("../../scripts_general/data_load.R")
```

```{r}
# show contrasts
contrasts(d3$epi_ctry)
contrasts(d3$epi_sample)
```


# Demographics

```{r}
# all participants included in dataset
d3 %>% distinct(epi_sample, epi_subj) %>% count(epi_sample)
```

```{r}
# participants missing porosity vignettes score
d3 %>% filter(is.na(por_score_std)) %>% count()

# participants missing spiritual experiences score
d3 %>% filter(is.na(spirit_score_std)) %>% count()

# participants with complete data for primary analysis
d3 %>% filter(!is.na(por_score_std),
              !is.na(spirit_score_std)) %>% count()
```


# Predicting Spiritual Events

## Attemping to fit more complex random effects structures

```{r}
r1a <- lmer(spirit_score_std ~ por_score_std + 
              (1 + por_score_std | epi_ctry/epi_sample), d3) # failed to converge
r1b <- lmer(spirit_score_std ~ por_score_std + 
              (1 + por_score_std || epi_ctry/epi_sample), d3) # failed to converge
r1c <- lmer(spirit_score_std ~ por_score_std + 
              (1 + por_score_std | epi_ctry), d3) # failed to converge
r1d <- lmer(spirit_score_std ~ por_score_std + 
              (1 + por_score_std || epi_ctry), d3) # failed to converge
r1e <- lmer(spirit_score_std ~ por_score_std + 
              (0 + por_score_std| epi_ctry), d3) # ok, missing random intercepts
r1f <- lmer(spirit_score_std ~ 0 + por_score_std + 
              (1 + por_score_std| epi_ctry/epi_sample), d3) # singular

```


## Primary analysis

```{r}
r1 <- lmer(spirit_score_std ~ por_score_std + 
             (1 | epi_ctry/epi_sample), d3)
summary(r1)
```

```{r}
rsquared(r1)
```

```{r}
regtab_fun(r1, por_name = "Porosity Scale") %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r1, country_var = "epi_ctry", religion_var = "epi_sample") %>% 
  regtab_style_fun()
```

## Bayesian regression

```{r}
# r1_bayes <- brm(spirit_score_std ~ por_score_std +
#                   (1 | epi_ctry/epi_sample), d3,
#                 control = list(adapt_delta = 0.99),
#                 seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_bayes, "./models/r1_bayes.RDS")

r1_bayes <- readRDS("./models/r1_bayes.RDS")

summary(r1_bayes)
```

```{r}
bayes_R2(r1_bayes)
```

```{r}
regtab_fun(r1_bayes, por_name = "Porosity Scale") %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r1_bayes, 
               country_var = "epi_ctry", 
               religion_var = "epi_sample", 
               religion_name = "Sample") %>% 
  regtab_style_fun()
```

## Country and sample as fixed effects

```{r}
r2 <- lm(spirit_score_std ~ por_score_std * epi_ctry * epi_sample, d3) 
summary(r2)
```

```{r}
rsquared(r2)
```

```{r}
regtab_fun(r2, 
           por_name = "Porosity Vignettes", 
           country_var1 = "epi_ctry_gh",
           country_var2 = "epi_ctry_th",
           country_var3 = "epi_ctry_ch",
           country_var4 = "epi_ctry_vt",
           religion_var = "epi_sample_ch",
           religion_name = "Sample (Ch.)") %>% 
  regtab_style_fun(row_emph = 2)
```


# Predicting Other Extraordinary Events

```{r}
r3 <- lmer(other_score_std ~ por_score_std +
             (1 | epi_ctry/epi_sample),
           data = d3)
summary(r3)
```

```{r}
rsquared(r3)
```

```{r}
regtab_fun(r3, por_name = "Porosity Vignettes") %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r3, 
               country_var = "epi_ctry", 
               religion_var = "epi_sample",
               religion_name = "Sample") %>% 
  regtab_style_fun()
```
