---
title: "Study 2"
subtitle: "Luhrmann, Weisman, et al."
output: 
  html_notebook:
    theme: flatly
    toc: true
    toc_float: true
---

In this notebook, we analyze Study 2: Pen-and-paper surveys with undergraduates.

```{r}
source("../../scripts_general/dependencies.R")
source("../../scripts_general/custom_funs.R")
source("../../scripts_general/var_recode_contrast.R")
source("../../scripts_general/data_load.R")
```

```{r}
# show contrasts
contrasts(d2_byquestion$country)
contrasts(d2$country)
```


# Demographics

```{r}
# all participants included in dataset
d2 %>% distinct(subj) %>% count()
```

```{r}
# participants missing absorption score
d2 %>% 
  filter(is.na(abs_score)) %>% 
  distinct(as.character(subj)) %>%
  count()

# participants missing daily spiritual experiences score
d2 %>% 
  filter(is.na(dse_score)) %>% 
  distinct(as.character(subj)) %>% 
  count()

# participants missing spiritual events score
d2 %>% 
  filter(is.na(spev_score)) %>% 
  distinct(as.character(subj)) %>% 
  count()

# participants with complete data for primary analysis
d2 %>% 
  filter(!is.na(abs_score),
         !is.na(dse_score),
         !is.na(spev_score)) %>% 
  distinct(as.character(subj)) %>% 
  count()
```

XX FILL IN MORE DEMOGRAPHICS


# Predicting Spiritual Experiences

```{r}
d2_long <- d2 %>%
  select(country, subj, abs_score_std, dse_score_std, spev_score_std) %>%
  gather(spirit_scale, spirit_score_std, 
         c(dse_score_std, spev_score_std)) %>%
  mutate(spirit_scale = factor(spirit_scale, 
                               levels = c("dse_score_std", "spev_score_std")))

contrasts(d2_long$country) <- contrasts_country; contrasts(d2_long$country)
contrasts(d2_long$spirit_scale) <- cbind("_spev" = c(-1, 1)); contrasts(d2_long$spirit_scale)
```

## Attempting to fit more complex random effects structures

```{r}
# more complex random effects structures: NOT REPORTED
# note: never looking for intercepts (random or fixed) by scale, because standardized
r1a <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | country/subj) +
              (0 + abs_score_std | country) +
              (0 + abs_score_std | spirit_scale),
            data = d2_long) # singular

r1b <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | country/subj) +
              (0 + abs_score_std | country),
            data = d2_long) # singular

r1c <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | country/subj) +
              (0 + abs_score_std | spirit_scale),
            data = d2_long) # overparameterized: only 1 df for testing main effect of abs_score

r1d <- lmer(spirit_score_std ~ abs_score_std + 
              (0 + abs_score_std | country) +
              (0 + abs_score_std | spirit_scale),
            data = d2_long) # fine, but doesn't reflect repeated measures design

r1e <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 + abs_score_std | country), # singular
            # (1 + abs_score_std || country), # failed to converge
            data = d2_long) # singular

r1f <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 | country/subj),
            data = d2_long) # fine, but doesn't account for two scales

r1g <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (0 + abs_score_std | spirit_scale),
            data = d2_long) # overparameterized: only 1 df for testing main effect of abs_score

r1h <- lmer(spirit_score_std ~ 1 + abs_score_std +
              (1 + abs_score_std | country) + (1 | subj),
            data = d2_long) # singular
```

```{r}
r1i_dse <- lmer(dse_score_std ~ abs_score_std +
                  (1 + abs_score_std | country), d2) # singular

r1i_spev <- lmer(spev_score_std ~ abs_score_std +
                   (1 + abs_score_std | country), d2) # singular
```



## Primary analysis

### Daily Spiritual Experiences

```{r}
r1_dse <- lmer(dse_score_std ~ abs_score_std + 
                 (1 + abs_score_std || country), d2)
summary(r1_dse)
```

```{r}
rsquared(r1_dse)
```

```{r}
regtab_fun(r1_dse) %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r1_dse) %>% regtab_style_fun()
```

### Spiritual Events

```{r}
r1_spev <- lmer(spev_score_std ~ abs_score_std + 
                  (1 + abs_score_std || country), d2)
summary(r1_spev)
```

```{r}
rsquared(r1_spev)
```

```{r}
regtab_fun(r1_spev) %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r1_spev) %>% regtab_style_fun()
```

## Bayesian regression

### Daily Spiritual Experiences

```{r}
# r1_dse_bayes <- brm(dse_score_std ~ abs_score_std +
#                       (1 + abs_score_std || country), d2,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_dse_bayes, "./models/r1_dse_bayes.RDS")

r1_dse_bayes <- readRDS("./models/r1_dse_bayes.RDS")

summary(r1_dse_bayes)
```

```{r}
bayes_R2(r1_dse_bayes)
```

```{r}
regtab_fun(r1_dse_bayes) %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r1_dse_bayes) %>% regtab_style_fun()
```

### Spiritual Events

```{r}
# r1_spev_bayes <- brm(spev_score_std ~ abs_score_std +
#                       (1 + abs_score_std || country), d2,
#                     control = list(adapt_delta = 0.99),
#                     seed = 1234, cores = 4, chains = 4)
# saveRDS(r1_spev_bayes, "./models/r1_spev_bayes.RDS")

r1_spev_bayes <- readRDS("./models/r1_spev_bayes.RDS")

summary(r1_spev_bayes)
```

```{r}
bayes_R2(r1_spev_bayes)
```

```{r}
regtab_fun(r1_spev_bayes) %>% regtab_style_fun(row_emph = 2)
```

```{r}
regtab_ran_fun(r1_spev_bayes) %>% regtab_style_fun()
```

## Country as fixed effect

### Daily Spiritual Experiences

```{r}
r2_dse <- lm(dse_score_std ~ abs_score_std * country, d2)
summary(r2_dse)
```

```{r}
rsquared(r2_dse)
```

```{r}
regtab_fun(r2_dse) %>% regtab_style_fun(row_emph = 2)
```


### Spiritual Events

```{r}
r2_spev <- lm(spev_score_std ~ abs_score_std * country, d2)
summary(r2_spev)
```

```{r}
rsquared(r2_spev)
```

```{r}
regtab_fun(r2_spev) %>% regtab_style_fun(row_emph = 2)
```


